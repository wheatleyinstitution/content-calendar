import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  deleteDoc, 
  onSnapshot, 
  query, 
  orderBy,
  writeBatch, // Used for efficient bulk imports
  setDoc, // Used for updating existing documents
} from 'firebase/firestore';
import { 
  ChevronLeft, 
  ChevronRight, 
  Plus, 
  Trash2, 
  Clock, 
  ClipboardList,
  Tag, // Used for Initiative
  Upload, 
  Download,
  Link, // Used for Post Link
  Pencil, // New icon for Edit
  Check, // For Published status
  Minus, // For In Review status
  Instagram, // NEW ICON
  Linkedin, // NEW ICON
  BookOpen, // NEW ICON for General Event/Institute Placeholder
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config); 
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Constants ---
const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

const months = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

// Content Channels/Platforms 
const CHANNELS = [
  'Instagram',
  'LinkedIn',
  'General Event',
];

// Content Statuses 
const STATUSES = [
  'In Review',
  'Ready to Publish',
  'Published',
];

// Initiatives (Dropdown Order)
const INITIATIVES = [
  'Scholars',
  'General',
  'Constitution',
  'Family',
  'Religion',
];

// Content Post Formats (Dropdown)
const POST_FORMATS = [
    'Image',
    'Carousel',
    'Video',
    'Story',
    'Reel',
    'Live/Event',
];

// Visual Category Colors (FINAL FIX: Using exact HEX codes and high contrast text)
const COLORS = [
  // 0. Initiative: Scholars -> Charcoal (#414042) 
  { name: 'Scholars', hex: '#414042', dot: 'bg-[#414042]', class: 'bg-[#414042] text-white border-[#2A2A2A] font-bold' },
  // 1. Initiative: General -> Red (Standard Red) 
  { name: 'General', hex: '#FF0000', dot: 'bg-red-600', class: 'bg-red-600 text-white border-red-800 font-bold' }, 
  // 2. Initiative: Constitution -> Navy Blue (#002E5D) 
  { name: 'Constitution', hex: '#002E5D', dot: 'bg-[#002E5D]', class: 'bg-[#002E5D] text-white border-[#001D3C] font-bold' },
  // 3. Initiative: Family -> Sand (#D1CCBD)
  { name: 'Family', hex: '#D1CCBD', dot: 'bg-[#D1CCBD]', class: 'bg-[#D1CCBD] text-[#414042] border-[#A8A596] font-bold' },
  // 4. Initiative: Religion -> Green (#00966C) 
  { name: 'Religion', hex: '#00966C', dot: 'bg-[#00966C]', class: 'bg-[#00966C] text-white border-[#007A57] font-bold' }, 
];

// --- Status Icon Component ---
const StatusIcon = ({ status }) => {
  switch (status) {
    case 'Published':
      return <Check className="w-3 h-3 text-white bg-green-600 rounded-full p-[1px] flex-shrink-0" />;
    case 'Ready to Publish':
      return <Plus className="w-3 h-3 text-white bg-blue-600 rounded-full p-[1px] flex-shrink-0" />;
    case 'In Review':
    default:
      return <Minus className="w-3 h-3 text-white bg-yellow-600 rounded-full p-[1px] flex-shrink-0" />;
  }
};

// --- NEW Channel Icon Component ---
const ChannelIcon = ({ channel }) => {
    let IconComponent;
    let iconClass = "w-4 h-4 text-slate-800";
    let bgClass = "bg-white/90";

    switch (channel) {
        case 'Instagram':
            IconComponent = Instagram;
            iconClass = "w-3.5 h-3.5 text-pink-600";
            break;
        case 'LinkedIn':
            IconComponent = Linkedin;
            iconClass = "w-3.5 h-3.5 text-blue-700";
            break;
        case 'General Event':
        default:
            IconComponent = BookOpen; // Wheatley Institute placeholder (learning/academic)
            iconClass = "w-3.5 h-3.5 text-indigo-700";
            break;
    }

    return (
        <span 
            className={`font-bold text-xs uppercase w-5 h-5 flex items-center justify-center rounded-full ${bgClass} flex-shrink-0`} 
            title={`Channel: ${channel}`}
        >
            <IconComponent className={iconClass} />
        </span>
    );
};
// --- END Channel Icon Component ---


// --- Main Component ---
export default function App() {
  const [user, setUser] = useState(null);
  const [events, setEvents] = useState([]);
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null); 
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [migrationStatus, setMigrationStatus] = useState(null);
  
  const fileInputRef = useRef(null);

  // --- NEW STATE FOR EDITING ---
  const [editingEvent, setEditingEvent] = useState(null);

  // States for new scheduled item (used by both Add and Edit form)
  const [newSummary, setNewSummary] = useState(''); 
  const [newEventTime, setNewEventTime] = useState('09:00');
  const [newChannel, setNewChannel] = useState(CHANNELS[0]); 
  const [newStatus, setNewStatus] = useState(STATUSES[0]); 
  const [newInitiative, setNewInitiative] = useState(INITIATIVES[0]); 
  const [newFormat, setNewFormat] = useState(POST_FORMATS[0]); 
  const [newLink, setNewLink] = useState(''); 
  const [selectedColor, setSelectedColor] = useState(COLORS[0]);
  const [loading, setLoading] = useState(true);

  // --- Auth & Data Initialization ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (token) {
          await signInWithCustomToken(auth, token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth failed:", error);
      }
    };

    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // --- Real-time Data Listener ---
  useEffect(() => {
    if (!user) return;

    const eventsRef = collection(db, 'artifacts', appId, 'public', 'data', 'calendar_events');
    const q = query(eventsRef, orderBy('createdAt', 'desc')); 

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedEvents = snapshot.docs.map(doc => ({
        id: doc.id,
        // Map new field names, but assume 'title' is the summary
        title: doc.data().title || '', 
        channel: doc.data().channel || CHANNELS[0], 
        status: doc.data().status || STATUSES[0],
        initiative: doc.data().initiative || INITIATIVES[0], // Updated initiative default
        format: doc.data().format || POST_FORMATS[0], // New format
        link: doc.data().link || '', // New link
        ...doc.data()
      }));
      setEvents(fetchedEvents);
    }, (error) => {
      console.error("Error fetching events:", error);
    });

    return () => unsubscribe();
  }, [user]);

  // --- Data Migration Handlers (Export/Import) ---

  const handleExportData = () => {
    if (events.length === 0) {
      setMigrationStatus({ type: 'error', message: 'No data to export.' });
      setTimeout(() => setMigrationStatus(null), 3000);
      return;
    }
    setMigrationStatus({ type: 'exporting', message: `Exporting ${events.length} items...` });

    try {
      const exportableEvents = events.map(event => {
        const { id, createdBy, ...rest } = event;
        return rest;
      });
      
      const json = JSON.stringify(exportableEvents, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Wheatley_Calendar_Export_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      setMigrationStatus({ type: 'success', message: 'Export successful!' });
    } catch (e) {
      console.error("Export failed:", e);
      setMigrationStatus({ type: 'error', message: 'Export failed. Check console for details.' });
    } finally {
      setTimeout(() => setMigrationStatus(null), 3000);
    }
  };

  const handleFileChange = (event) => {
    const file = event.target.files[0];
    if (file) {
      handleImportData(file);
    }
  };

  const handleImportData = (file) => {
    setMigrationStatus({ type: 'importing', message: 'Starting import...' });

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (!Array.isArray(data)) {
          throw new Error("Invalid file format. Expected an array of events.");
        }

        const batch = writeBatch(db);
        const eventsRef = collection(db, 'artifacts', appId, 'public', 'data', 'calendar_events');
        
        const itemsToImport = data.slice(0, 499); 
        
        itemsToImport.forEach(item => {
          const newDocRef = doc(eventsRef);
          batch.set(newDocRef, {
            ...item,
            createdAt: new Date().toISOString(),
            createdBy: user.uid,
            // Ensure required fields exist in case old export format was missing them
            title: item.title || 'Imported Item',
            channel: item.channel || CHANNELS[0],
            status: item.status || STATUSES[0],
            initiative: item.initiative || INITIATIVES[0],
            format: item.format || POST_FORMATS[0],
            link: item.link || '',
          });
        });

        await batch.commit();
        setMigrationStatus({ type: 'success', message: `Successfully imported ${itemsToImport.length} items!` });

      } catch (error) {
        console.error("Import failed:", error);
        setMigrationStatus({ type: 'error', message: `Import failed: ${error.message}` });
      } finally {
        setTimeout(() => setMigrationStatus(null), 5000);
      }
    };
    reader.readAsText(file);
  };
  
  const triggerImport = () => {
    if (fileInputRef.current) {
      fileInputRef.current.click();
    }
  };


  // --- Calendar Handlers ---

  const closeModal = () => {
    setIsModalOpen(false);
    setEditingEvent(null); // Clear editing state on close
  };

  const handleGoToToday = () => {
    setCurrentDate(new Date());
  };

  const handlePrevMonth = () => {
    setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
  };

  const handleNextMonth = () => {
    setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
  };

  const handleDateClick = (day) => {
    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    setSelectedDate(dateStr);
    
    // Reset form states for new event entry
    setNewSummary(''); 
    setNewEventTime('09:00');
    setNewChannel(CHANNELS[0]); 
    setNewStatus(STATUSES[0]);
    setNewInitiative(INITIATIVES[0]); 
    setNewFormat(POST_FORMATS[0]); 
    setNewLink(''); 
    setSelectedColor(COLORS.find(c => c.name === INITIATIVES[0]) || COLORS[0]);
    setEditingEvent(null); // Ensure we are in 'Add New' mode
    
    setIsModalOpen(true);
  };

  // --- NEW: Function to load an existing event into the form for editing ---
  const handleEditClick = (event) => {
    setEditingEvent(event);
    setSelectedDate(event.date); // Ensure date is correct if modal was opened on another date
    setNewSummary(event.title);
    setNewEventTime(event.time);
    setNewChannel(event.channel); 
    setNewStatus(event.status); 
    setNewInitiative(event.initiative); 
    setNewFormat(event.format); 
    setSelectedColor(COLORS[event.colorIndex] || COLORS[0]);
    setNewLink(event.link); 
  };

  // --- REFACTORED: Handles both Adding (if no editingEvent) and Updating (if editingEvent exists) ---
  const handleSaveEvent = async (e) => {
    e.preventDefault();
    if (!newSummary.trim() || !selectedDate) return;

    try {
      const eventsRef = collection(db, 'artifacts', appId, 'public', 'data', 'calendar_events');
      const colorIndex = COLORS.findIndex(c => c.name === newInitiative);
      
      const eventData = {
        title: newSummary, 
        date: selectedDate,
        time: newEventTime,
        channel: newChannel, 
        status: newStatus, 
        initiative: newInitiative, 
        format: newFormat,
        link: newLink,
        colorIndex: colorIndex !== -1 ? colorIndex : 0,
        createdBy: user.uid
      };

      if (editingEvent) {
        // UPDATE existing document
        const eventDoc = doc(eventsRef, editingEvent.id);
        await setDoc(eventDoc, eventData, { merge: true });
      } else {
        // ADD new document
        await addDoc(eventsRef, {
            ...eventData,
            createdAt: new Date().toISOString(), // Only set creation time for new docs
        });
      }

      // Reset form and close modal
      closeModal();

    } catch (error) {
      console.error("Error saving event:", error);
    }
  };

  const handleDeleteEvent = async (eventId) => {
    try {
      const eventDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calendar_events', eventId);
      await deleteDoc(eventDoc);
    } catch (error) {
      console.error("Error deleting event:", error);
    }
  };

  // --- Render Logic ---
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const daysInMonth = getDaysInMonth(year, month);
  const firstDayOfMonth = getFirstDayOfMonth(year, month);
  const paddingDays = Array(firstDayOfMonth).fill(null);
  const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

  // Filter events for the current view (client-side)
  const getEventsForDay = (day) => {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    return events.filter(e => e.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
  };

  const getEventsForSelectedDate = () => {
    if (!selectedDate) return [];
    return events.filter(e => e.date === selectedDate).sort((a, b) => a.time.localeCompare(b.time));
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-slate-50">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-900">
      
      {/* Header */}
      <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm">
        <div className="flex items-center space-x-3">
          <div className="bg-indigo-100 p-2 rounded-lg">
            <ClipboardList className="w-6 h-6 text-indigo-600" />
          </div>
          <h1 className="text-xl font-bold text-slate-800">Wheatley Institute Social Media Calendar</h1>
        </div>
        <div className="flex items-center space-x-4">
          
          {/* Data Migration Tools */}
          <div className="flex space-x-2">
            <input 
              type="file" 
              ref={fileInputRef} 
              onChange={handleFileChange} 
              className="hidden" 
              accept=".json" 
            />
            <button 
              onClick={handleExportData} 
              className="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 text-sm font-medium rounded-lg transition-colors flex items-center"
              title="Download all calendar data to a JSON file."
            >
              <Download className='w-4 h-4 mr-1' /> Export
            </button>
            <button 
              onClick={triggerImport} 
              className="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 text-sm font-medium rounded-lg transition-colors flex items-center"
              title="Upload data from a previously exported JSON file."
            >
              <Upload className='w-4 h-4 mr-1' /> Import
            </button>
          </div>
          
          {/* Calendar Navigation */}
          <button 
            onClick={handleGoToToday} 
            className="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-medium rounded-lg transition-colors shadow-md shadow-indigo-200"
          >
            Today
          </button>
          <div className="flex items-center bg-slate-100 rounded-lg p-1">
            <button onClick={handlePrevMonth} className="p-2 hover:bg-white hover:shadow-sm rounded-md transition-all">
              <ChevronLeft className="w-5 h-5 text-slate-600" />
            </button>
            <span className="w-40 text-center font-semibold text-slate-700 select-none">
              {months[month]} {year}
            </span>
            <button onClick={handleNextMonth} className="p-2 hover:bg-white hover:shadow-sm rounded-md transition-all">
              <ChevronRight className="w-5 h-5 text-slate-600" />
            </button>
          </div>
        </div>
      </header>
      
      {/* Migration Status Message */}
      {migrationStatus && (
        <div className={`px-6 py-2 text-center text-sm font-medium ${
            migrationStatus.type === 'success' ? 'bg-green-100 text-green-800' : 
            migrationStatus.type === 'error' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
        }`}>
          {migrationStatus.message}
        </div>
      )}

      {/* Main Calendar Grid */}
      <main className="flex-1 p-6 overflow-auto">
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
          {/* Weekday Headers */}
          <div className="grid grid-cols-7 border-b border-slate-200 bg-slate-50">
            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
              <div key={day} className="py-3 text-center text-sm font-semibold text-slate-500 uppercase tracking-wider">
                {day}
              </div>
            ))}
          </div>

          {/* Days Grid */}
          <div className='grid grid-cols-7 flex-1 auto-rows-fr'>
            {paddingDays.map((_, index) => (
              <div key={`padding-${index}`} className="bg-slate-50/50 border-b border-r border-slate-100 min-h-[120px]"></div>
            ))}
            
            {days.map(day => {
              const dayEvents = getEventsForDay(day);
              const isToday = 
                day === new Date().getDate() && 
                month === new Date().getMonth() && 
                year === new Date().getFullYear();

              return (
                <div 
                  key={day} 
                  onClick={() => handleDateClick(day)}
                  className={`
                    border-b border-r border-slate-100 p-2 min-h-[120px] cursor-pointer transition-colors hover:bg-slate-50 relative group
                    ${isToday ? 'bg-indigo-50/30' : 'bg-white'}
                  `}
                >
                  <div className="flex justify-between items-start mb-2">
                    <span className={`
                      text-sm font-medium w-7 h-7 flex items-center justify-center rounded-full
                      ${isToday ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-700 group-hover:bg-slate-200'}
                    `}>
                      {day}
                    </span>
                    {dayEvents.length > 0 && (
                      <span className="text-xs text-slate-400 font-medium md:hidden">
                        {dayEvents.length}
                      </span>
                    )}
                  </div>
                  
                  <div className="space-y-1">
                    {dayEvents.slice(0, 4).map(event => { // Show max 4 events per cell
                       const color = COLORS[event.colorIndex] || COLORS[0];
                       return (
                        <div key={event.id} className={`text-xs px-2 py-1 rounded-md border ${color.class} flex items-center space-x-1`}>
                          
                          {/* Status Icon */}
                          <StatusIcon status={event.status} />

                          {/* Channel Icon (UPDATED) */}
                          <ChannelIcon channel={event.channel} />
                          
                          <span className="font-semibold">{event.time}</span>
                          <span className="truncate text-white">{event.title}</span>
                        </div>
                       );
                    })}
                    {dayEvents.length > 4 && (
                      <div className="text-xs text-slate-400 pl-1 font-medium">
                        + {dayEvents.length - 4} more
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* --- Color Key / Legend --- */}
        <div className="mt-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <h3 className="text-sm font-bold text-slate-800 mb-3">Initiative Color Key</h3>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 text-xs">
                {COLORS.map((color) => (
                    <div key={color.name} className="flex items-center space-x-2">
                        <div className={`w-3 h-3 rounded-full ${color.dot} flex-shrink-0`}></div>
                        <span className="text-slate-600 font-medium">{color.name}</span>
                    </div>
                ))}
                {/* Status Key */}
                 <div className="flex items-center space-x-2">
                    <Check className="w-3 h-3 text-white bg-green-600 rounded-full p-[1px] flex-shrink-0" />
                    <span className="text-slate-600 font-medium">Published</span>
                </div>
                <div className="flex items-center space-x-2">
                    <Plus className="w-3 h-3 text-white bg-blue-600 rounded-full p-[1px] flex-shrink-0" />
                    <span className="text-slate-600 font-medium">Ready to Publish</span>
                </div>
                 <div className="flex items-center space-x-2">
                    <Minus className="w-3 h-3 text-white bg-yellow-600 rounded-full p-[1px] flex-shrink-0" />
                    <span className="text-slate-600 font-medium">In Review</span>
                </div>
            </div>
        </div>
        {/* --- END Color Key / Legend --- */}

      </main>

      {/* Event Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
            
            {/* Modal Header */}
            <div className="px-6 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
              <div>
                <h2 className="text-lg font-bold text-slate-800">
                  {new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' })}
                </h2>
                <p className="text-xs text-slate-500">Manage all content items</p>
              </div>
              <button 
                onClick={closeModal}
                className="text-slate-400 hover:text-slate-600 transition-colors"
              >
                <span className="text-2xl">&times;</span>
              </button>
            </div>

            {/* Modal Body */}
            <div className="p-6">
              
              {/* Event List for Selected Date */}
              <div className="space-y-3 mb-6 max-h-60 overflow-y-auto pr-1">
                {getEventsForSelectedDate().length === 0 ? (
                  <div className="text-center py-8 text-slate-400 bg-slate-50 rounded-lg border border-dashed border-slate-200">
                    No items scheduled yet! Click 'Schedule New Item' below.
                  </div>
                ) : (
                  getEventsForSelectedDate().map(event => {
                    const color = COLORS[event.colorIndex] || COLORS[0];
                    return (
                      <div 
                        key={event.id} 
                        className={`flex items-start group bg-white border border-slate-100 p-3 rounded-lg hover:shadow-md transition-all cursor-pointer ${editingEvent?.id === event.id ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''}`}
                      >
                        <div className={`w-3 h-3 rounded-full mr-3 mt-1 flex-shrink-0 ${color.dot}`} title={`Initiative: ${color.name}`}></div>
                        <div className="flex-1 min-w-0">
                          <p className="text-xs font-semibold text-indigo-600 mb-0.5">
                            {event.channel} <span className='text-slate-400'>•</span> {event.format} <span className='text-slate-400'>•</span> {event.status}
                          </p>
                          {/* Allowing full wrapping here for details */}
                          <p className="text-sm font-bold text-slate-800">{event.title}</p>
                          <p className="text-xs text-slate-500 italic mt-1 flex items-center">
                            <Tag className="w-3 h-3 mr-1" />
                            <span className='truncate font-medium'>{event.initiative}</span>
                          </p>
                          <p className="text-xs text-slate-500 flex items-center mt-1">
                            <Clock className="w-3 h-3 mr-1" /> {event.time}
                            {event.link && (
                                <a href={event.link} target="_blank" rel="noopener noreferrer" className="ml-3 text-indigo-500 hover:text-indigo-700 flex items-center">
                                    <Link className="w-3 h-3 mr-1" /> Link
                                </a>
                            )}
                          </p>
                        </div>
                        <button 
                          type="button"
                          onClick={() => handleEditClick(event)}
                          className="text-indigo-400 hover:text-indigo-600 p-2 transition-all flex-shrink-0"
                          title="Edit Item"
                        >
                          <Pencil className="w-4 h-4" />
                        </button>
                        <button 
                          onClick={() => handleDeleteEvent(event.id)}
                          className="text-red-400 hover:text-red-600 p-2 transition-all flex-shrink-0"
                          title="Delete Item"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    );
                  })
                )}
              </div>

              {/* Add/Edit Event Form */}
              <form onSubmit={handleSaveEvent} className="pt-6 border-t border-slate-100">
                <h3 className="text-sm font-bold text-slate-800 mb-4 flex items-center">
                  {editingEvent ? <Pencil className="w-4 h-4 mr-1" /> : <Plus className="w-4 h-4 mr-1" />}
                  {editingEvent ? 'Edit Selected Item' : 'Schedule New Item'}
                  {editingEvent && (
                    <button 
                      type="button" 
                      onClick={() => handleDateClick(new Date(selectedDate).getDate())} // Re-open as new item on current date
                      className='ml-auto text-xs text-red-500 hover:text-red-700 font-normal underline'
                    >
                      + Add New
                    </button>
                  )}
                </h3>
                
                <div className="space-y-3">
                  
                  {/* Channel, Format, and Status */}
                  <div className='flex space-x-2'>
                      <select
                          value={newChannel}
                          onChange={(e) => setNewChannel(e.target.value)}
                          className="w-1/3 px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm appearance-none bg-white pr-8"
                          title="Channel"
                      >
                          {CHANNELS.map(type => (
                          <option key={type} value={type}>{type}</option>
                          ))}
                      </select>
                       <select
                          value={newFormat}
                          onChange={(e) => setNewFormat(e.target.value)}
                          className="w-1/3 px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm appearance-none bg-white pr-8"
                          title="Format"
                      >
                          {POST_FORMATS.map(format => (
                          <option key={format} value={format}>{format}</option>
                          ))}
                      </select>
                      <select
                          value={newStatus}
                          onChange={(e) => setNewStatus(e.target.value)}
                          className="w-1/3 px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm appearance-none bg-white pr-8"
                          title="Status"
                      >
                          {STATUSES.map(status => (
                          <option key={status} value={status}>{status}</option>
                          ))}
                      </select>
                  </div>

                  {/* Summary Input */}
                  <input
                    type="text"
                    placeholder="Brief Summary / Post Title (Required)"
                    value={newSummary}
                    onChange={(e) => setNewSummary(e.target.value)}
                    className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                    autoFocus
                  />
                  
                  {/* Initiative Dropdown */}
                  <div className="flex items-center rounded-lg border border-slate-200 focus-within:ring-2 focus-within:ring-indigo-500/20 focus-within:border-indigo-500 transition-all">
                      <Tag className="w-4 h-4 text-slate-400 ml-3 flex-shrink-0" />
                      <select
                          value={newInitiative}
                          onChange={(e) => {
                            setNewInitiative(e.target.value);
                            // Auto-set color based on initiative selection
                            const newColor = COLORS.find(c => c.name === e.target.value) || COLORS[0];
                            setSelectedColor(newColor);
                          }}
                          className="w-full px-3 py-2 bg-transparent focus:outline-none text-sm appearance-none"
                          title="Strategic Initiative"
                      >
                          {INITIATIVES.map(initiative => (
                          <option key={initiative} value={initiative}>{initiative}</option>
                          ))}
                      </select>
                  </div>
                  
                  {/* Link Input */}
                  <div className="flex items-center rounded-lg border border-slate-200 focus-within:ring-2 focus-within:ring-indigo-500/20 focus-within:border-indigo-500 transition-all">
                      <Link className="w-4 h-4 text-slate-400 ml-3 flex-shrink-0" />
                      <input
                          type="url"
                          placeholder="Post Link / URL (Optional)"
                          value={newLink}
                          onChange={(e) => setNewLink(e.target.value)}
                          className="w-full px-3 py-2 bg-transparent focus:outline-none text-sm"
                      />
                  </div>

                  <div className="flex space-x-3 items-center">
                    <input
                      type="time"
                      value={newEventTime}
                      onChange={(e) => setNewEventTime(e.target.value)}
                      className="w-1/3 px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                      title="Post Time"
                    />
                    
                    <div className="flex-1 flex justify-end space-x-1 items-center">
                      <span className='text-xs font-medium text-slate-500 mr-2'>Category Color:</span>
                      {COLORS.map((color) => (
                        <button
                          key={color.name}
                          type="button"
                          onClick={() => setSelectedColor(color)}
                          className={`
                            w-6 h-6 rounded-full transition-transform hover:scale-110
                            ${color.dot} 
                            ${selectedColor.name === color.name ? 'ring-2 ring-offset-2 ring-slate-400' : ''}
                          `}
                          title={`Color: ${color.name}`}
                        />
                      ))}
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={!newSummary.trim()}
                    className="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 rounded-lg shadow-sm shadow-indigo-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {editingEvent ? 'Save Changes' : 'Schedule Item'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
